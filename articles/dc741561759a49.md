---
title: "GitHub Actionsã§git submoduleã‚’æ›´æ–°ã™ã‚‹"
emoji: "ğŸ±"
type: "tech"
topics: ["git", "github", "githubactions"]
published: true
---

GitHub Actionsã§submoduleã‚’æ‰±ã†è¨˜äº‹ã¯å¤šãã‚ã‚Šã¾ã™ãŒã€å€‹äººã§ã‚„ã£ã¦ã„ã‚‹æ–¹æ³•ã«ã¤ã„ã¦ã¾ã¨ã‚ãŸã„ã¨æ€ã„ã¾ã™ã€‚

submoduleè‡ªä½“ã«ã¤ã„ã¦ã¯ã€ä»¥ä¸‹ã®è¨˜äº‹ãŒsubmoduleã‚’åˆ©ç”¨ã™ã‚‹ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ãªã©ã‚‚å«ã‚ã¦ã€ã‹ãªã‚Šåˆ†ã‹ã‚Šã‚„ã™ãã¾ã¨ã¾ã£ã¦ã„ã‚‹ã¨æ€ã„ã¾ã™ã€‚

https://www.m3tech.blog/entry/git-submodule

# GitHub Actionsã®ä½œæˆ

ä½œæˆã—ãŸGitHub Actionsã§ã™ãŒã€ãƒã‚¤ãƒ³ãƒˆã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

- actions/checkoutã§submoduleã‚‚HTTPã§cloneã™ã‚‹
    - SSHéµè¨­å®šã¯ä¸è¦
- `git submodule update --remote --recursive`ã‚³ãƒãƒ³ãƒ‰ã§æ›´æ–°ã™ã‚‹
- `cron`ã§è‡ªå‹•å®Ÿè¡Œã™ã‚‹
- `workflow_dispatch`ã§æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

ä»Šå›ä½œæˆã—ãŸã‚‚ã®ã¯ä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã«ç½®ã„ã¦ã‚ã‚Šã¾ã™ã€‚

https://github.com/ymmmtym/templates

ã¾ãŸGitHub Actionsã‚’ä½œæˆã™ã‚‹ãƒªãƒã‚¸ãƒˆãƒªã«ã¯ã€æ—¢ã«submoduleã‚’è¿½åŠ ã—ã¦ã„ã‚‹ã“ã¨ã‚’å‰æã«ä½œæˆã—ã¦ã„ãã¾ã™ã€‚

## actions/checkoutã®ç¢ºèª

actions/checkoutã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ç¢ºèªã—ã¾ã™ã€‚

https://github.com/actions/checkout

æ™®æ®µã¯ãŠã¾ã˜ãªã„ã ã¨æ€ã£ã¦è„³æ­»ã§æ›¸ã„ã¦ã„ã‚‹ã¨ã“ã‚ã§ã™ãŒã€æ”¹ã‚ã¦ä½¿ç”¨æ–¹æ³•ã‚’ç¢ºèªã—ã¦ã¿ã¾ã™ã€‚

```yaml
- uses: actions/checkout@v2
  with:
    snip...

    # Whether to checkout submodules: `true` to checkout submodules or `recursive` to
    # recursively checkout submodules.
    #
    # When the `ssh-key` input is not provided, SSH URLs beginning with
    # `git@github.com:` are converted to HTTPS.
    #
    # Default: false
    submodules: ''
```

`submodule`ã¨è¨€ã†ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒä½¿ç”¨ã§ãã‚‹ã¨ã®ã“ã¨ãªã®ã§ã€`submodule: recursive`ã«è¨­å®šã—ã¦ä½¿ç”¨ã—ã¦ã¿ã¾ã™ã€‚

ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã«è¨˜è¼‰ã®é€šã‚Šã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿`ssh-key`ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã€
checkoutã®ã‚¹ãƒ†ãƒƒãƒ—ã§submoduleã‚‚cloneã™ã‚‹ã‚ˆã†ã«è¨­å®šã™ã‚‹ã¨è‡ªå‹•çš„ã«HTTPã§cloneã™ã‚‹ã‚ˆã†ã«åˆ‡ã‚Šæ›¿ã‚ã‚‹ã‚ˆã†ã§ã™ã€‚

`.gitmodules`ã«sshå½¢å¼ã§è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹å ´åˆã§ã‚‚é©ç”¨ã•ã‚Œã¾ã™ã€‚(å‹æ‰‹ã«æ›¸ãå¤‰ã‚ã‚‹äº‹ã¯ã‚ã‚Šã¾ã›ã‚“)

## git configã®è¨­å®š

`git submodule update --remote`ã¯ã€submoduleã‚’ãƒªãƒ¢ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã®å†…å®¹ã«æ›´æ–°ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã§ã™ãŒã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®branchãŒ`master`ã¨ãªã£ã¦ã„ã¾ã™ã€‚

ã“ã‚Œã‚’ä»–ã®branchã«å¤‰æ›´ã™ã‚‹å ´åˆã¯ã€ãƒ­ãƒ¼ã‚«ãƒ«ãƒªãƒã‚¸ãƒˆãƒªã§ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```bash
: git config -f .gitmodules submodule.<ãƒªãƒã‚¸ãƒˆãƒª>.branch <ãƒ–ãƒ©ãƒ³ãƒ>

# ä¾‹
git config -f .gitmodules submodule.template-gin.branch main
```

ã“ã‚Œã‚’submoduleåˆ†ã ã‘å®Ÿè¡Œã™ã‚‹ã¨ã€`.gitmodules`ãƒ•ã‚¡ã‚¤ãƒ«ã«`branch = main`ã¨ã„ã£ãŸå†…å®¹ãŒè¿½åŠ ã•ã‚Œã¾ã™ã€‚(ä»¥ä¸‹ã¯ä»Šå›ã®ãƒªãƒã‚¸ãƒˆãƒªã«ã‚ã‚‹ã‚‚ã®ã§ã™)

```bash
$ cat .gitmodules
[submodule "template-rails"]
	path = template-rails
	url = git@github.com:ymmmtym/template-rails.git
	branch = master
[submodule "template-mkdocs"]
	path = template-mkdocs
	url = git@github.com:ymmmtym/template-mkdocs.git
	branch = main
[submodule "template-deno"]
	path = template-deno
	url = git@github.com:ymmmtym/template-deno.git
	branch = main
[submodule "template-gin"]
	path = template-gin
	url = git@github.com:ymmmtym/template-gin.git
	branch = master
[submodule "template-django-polls"]
	path = template-django-polls
	url = git@github.com:ymmmtym/template-django-polls.git
	branch = master
[submodule "template-vue"]
	path = template-vue
	url = git@github.com:ymmmtym/template-vue.git
	branch = master
[submodule "template-node-express"]
	path = template-node-express
	url = git@github.com:ymmmtym/template-node-express.git
	branch = master
```

ã“ã®çŠ¶æ…‹ã§`git submodule update --remote --recursive`ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€submoduleæ¯ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹branchã«å¯¾ã—ã¦æ›´æ–°ã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚

## workflowã®ä½œæˆ

ä½œæˆã—ãŸymlã¯ä»¥ä¸‹ã«ãªã‚Šã¾ã™ã€‚

https://github.com/ymmmtym/templates/blob/main/.github/workflows/update_submodules.yml

```yaml:update_submodules.yml
name: Update submodules
on:
  schedule:
    - cron:  '0 * * * *'
  workflow_dispatch:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  update_submodules:
    name: Update submodules
    runs-on: ubuntu-18.04
    env:
      TZ: "Asia/Tokyo"
    if: contains(github.event.head_commit.message, '[ci skip]') == false
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: recursive
    - name: Update submodules
      id: update
      run: git submodule update --remote --recursive 
    - name: Run git status
      id: status
      run: echo "::set-output name=status::$(git status -s)"
    - name: Add and commit files
      run: |
        git add .
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git commit -m "Update submodules at $(date "+DATE: %Y-%m-%d TIME: %H:%M:%S")"
      if: ${{ steps.status.outputs.status }}
    - name: Push changes
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: main
      if: ${{ steps.status.outputs.status && github.event_name == 'push' }}
```

ã‚„ã£ã¦ã„ã‚‹å†…å®¹ã«ã¤ã„ã¦ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ãªã£ã¦ã„ã¦ã€`git status -s`ã§å·®åˆ†ãŒã‚ã£ãŸå ´åˆã¯ã€`git add .`ã¨`git commit`ã—ã¦mainãƒ–ãƒ©ãƒ³ãƒã«pushã™ã‚‹workflowã«ãªã£ã¦ã„ã¾ã™ã€‚
ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€cronã¨workflow_dispatchã«ã‚ˆã£ã¦mainãƒ–ãƒ©ãƒ³ãƒã§èµ·å‹•ã—ãŸã‚‚ã®ã¨ã€mainãƒ–ãƒ©ãƒ³ãƒã«pushã•ã‚ŒãŸã‚‚ã®ãŒæ›´æ–°ã•ã‚Œã€pushã•ã‚Œã¾ã™ã€‚

# ãã®ä»–

https://qiita.com/kshimo69/items/ac22d414d756ea08943f

`git submodule foreach git pull origin master`ã‚’å®Ÿè¡Œã™ã‚‹æ–¹æ³•ãŒã‚ã‚‹ã¨çŸ¥ã‚Šè©¦ã—ã¾ã—ãŸãŒã€ç§ã®ç’°å¢ƒã§ã¯å•é¡Œç‚¹ãŒã‚ã‚Šã¾ã—ãŸã€‚
ã¾ãš`git submodule foreach`ã¯å…¨ã¦ã®submoduleã«å¯¾ã—ã¦ã€åŒã˜gitå‹•ä½œã‚’è¡Œã†ã“ã¨ã«ãªã‚Šã¾ã™ã€‚
ãªã®ã§ã€mainã¨masterãªã©branchåãŒæ··åœ¨ã™ã‚‹æ™‚ã«ã¯ã‚¨ãƒ©ãƒ¼ã«ãªã£ã¦ã—ã¾ã„ã¾ã™ã€‚

https://haibara-works.hatenablog.com/entry/2020/06/13/035619

`repository_dispatch`ã‚’åˆ©ç”¨ã—ã¦ã€submoduleãŒæ›´æ–°ã•ã‚ŒãŸã“ã¨ã‚’ãƒˆãƒªã‚¬ãƒ¼ã«workflowã‚’å®Ÿè¡Œã§ãã‚‹ã¿ãŸã„ã§ã™ã€‚OSSä»¥å¤–ã‚’submoduleã¨ã—ã¦å°å…¥ã—ã¦ã„ã‚‹å ´åˆã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã ã¨æ„Ÿã˜ã¦ã„ã¾ã™ã€‚

# Reference

https://git-scm.com/book/ja/v2/Git-%E3%81%AE%E3%81%95%E3%81%BE%E3%81%96%E3%81%BE%E3%81%AA%E3%83%84%E3%83%BC%E3%83%AB-%E3%82%B5%E3%83%96%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB
https://stackoverflow.com/questions/64407333/using-github-actions-to-automatically-update-the-repos-submodules
https://qiita.com/kshimo69/items/ac22d414d756ea08943f
https://haibara-works.hatenablog.com/entry/2020/06/13/035619
https://www.m3tech.blog/entry/git-submodule
